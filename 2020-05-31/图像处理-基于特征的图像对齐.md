# å›¾åƒå¤„ç†-åŸºäºç‰¹å¾çš„å›¾åƒå¯¹é½

  - [æ¦‚è¿°](#%E6%A6%82%E8%BF%B0)
    - [ä»€ä¹ˆæ˜¯å›¾åƒå¯¹é½æˆ–å›¾åƒé…å‡†](#%E4%BB%80%E4%B9%88%E6%98%AF%E5%9B%BE%E5%83%8F%E5%AF%B9%E9%BD%90%E6%88%96%E5%9B%BE%E5%83%8F%E9%85%8D%E5%87%86)
    - [å›¾åƒå¯¹é½çš„åº”ç”¨åœºæ™¯](#%E5%9B%BE%E5%83%8F%E5%AF%B9%E9%BD%90%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF)
  - [å›¾åƒå¯¹é½ï¼šç†è®ºåŸºç¡€](#%E5%9B%BE%E5%83%8F%E5%AF%B9%E9%BD%90%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80)
    - [å•åº”æ€§çŸ©é˜µ](#%E5%8D%95%E5%BA%94%E6%80%A7%E7%9F%A9%E9%98%B5)
    - [å¦‚ä½•æ‰¾åˆ°å•åº”æ€§çŸ©é˜µ](#%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E5%8D%95%E5%BA%94%E6%80%A7%E7%9F%A9%E9%98%B5)
    - [å¦‚ä½•æ‰¾åˆ°ç‰¹å¾å…³é”®ç‚¹](#%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E7%89%B9%E5%BE%81%E5%85%B3%E9%94%AE%E7%82%B9)
  - [OpenCV å›¾åƒå¯¹é½ä»£ç ](#opencv-%E5%9B%BE%E5%83%8F%E5%AF%B9%E9%BD%90%E4%BB%A3%E7%A0%81)
    - [åŸºäºç‰¹å¾çš„å›¾åƒå¯¹é½æ­¥éª¤](#%E5%9F%BA%E4%BA%8E%E7%89%B9%E5%BE%81%E7%9A%84%E5%9B%BE%E5%83%8F%E5%AF%B9%E9%BD%90%E6%AD%A5%E9%AA%A4)
    - [ä»£ç æ¼”ç¤º](#%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA)
    - [ç»“æœå±•ç¤º](#%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA)
  - [å†™åœ¨æœ€å](#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E)


åœ¨2020å¹´5æœˆ30å·é‚£å¤©ï¼Œæˆ‘ä»‹ç»äº† [ORB_FAST ç‰¹å¾å…³é”®ç‚¹æ£€æµ‹](../2020-05-30/å›¾åƒå¤„ç†-ORB_FASTç‰¹å¾å…³é”®ç‚¹æ£€æµ‹.md)å’Œ [BRIEF ç‰¹å¾æè¿°å­åŒ¹é…](../2020-05-30/å›¾åƒå¤„ç†-BRIEFç‰¹å¾æè¿°å­åŒ¹é….md)ã€‚å®é™…ä¸Šï¼Œå®ƒä»¬éƒ½å¯ä»¥å½’ä¸ºåŸºäºç‰¹å¾çš„å›¾åƒå¯¹é½æŠ€æœ¯ã€‚åœ¨è¿™é‡Œè¿›è¡Œä¸€ä¸ªæ€»ç»“ã€‚

## æ¦‚è¿°

![image-alignment-using-opencv](https://cdn.jsdelivr.net/gh/ylsislove/image-home/test/image-alignment-using-opencv.jpg)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒåŸºäºç‰¹å¾çš„å›¾åƒå¯¹å…¶æ–¹æ³•ï¼Œä¼šæŠŠæ‰‹æœºæ‹æ‘„çš„è¡¨å•å’Œè¡¨å•çš„æ¨¡æ¿å¯¹é½ã€‚

è¿™é‡Œç”¨åˆ°çš„æŠ€æœ¯è¢«ç§°ä¸ºåŸºäºç‰¹å¾çš„å›¾åƒå¯¹é½ï¼Œå› ä¸ºåœ¨è¿™ç§æŠ€æœ¯ä¸­ï¼Œè¦åœ¨ä¸€ä¸ªå›¾åƒä¸­æ£€æµ‹åˆ°ä¸€ç»„ç‰¹å¾ç‚¹ï¼Œå¹¶ä¸å¦ä¸€å¼ å›¾åƒä¸­çš„ç‰¹å¾ç‚¹ç›¸åŒ¹é…ã€‚ç„¶åæ ¹æ®è¿™äº›åŒ¹é…çš„ç‰¹å¾ç‚¹è®¡ç®—å‡ºä¸€ä¸ªè½¬æ¢è§„åˆ™ï¼Œä»è€Œå°†ä¸€ä¸ªå›¾åƒæ˜ å°„åˆ°å¦ä¸€ä¸ªå›¾åƒä¸Šã€‚

### ä»€ä¹ˆæ˜¯å›¾åƒå¯¹é½æˆ–å›¾åƒé…å‡†
å›¾åƒå¯¹é½ï¼ˆä¹Ÿç§°å›¾åƒé…å‡†ï¼‰å¯ä»¥æ‰­æ›²æ—‹è½¬ï¼ˆå…¶å®æ˜¯ä»¿å°„å˜æ¢ï¼‰ä¸€å¼ å›¾ä½¿å®ƒå’Œå¦ä¸€ä¸ªå›¾å¯ä»¥å¾ˆå®Œç¾çš„å¯¹é½ã€‚

### å›¾åƒå¯¹é½çš„åº”ç”¨åœºæ™¯
* è¡¨å•å¯¹é½
* åœ¨ä¸€äº›åŒ»å­¦åº”ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦æŠŠå¤šæ¬¡æ‹æ‘„çš„ç…§ç‰‡æ‹¼æ¥èµ·æ¥
* æœ€æœ‰æ„æ€çš„åº”ç”¨åº”è¯¥å°±æ˜¯åˆæˆå…¨æ™¯å›¾ç‰‡äº†

## å›¾åƒå¯¹é½ï¼šç†è®ºåŸºç¡€
å›¾åƒå¯¹é½æŠ€æœ¯çš„æ ¸å¿ƒæ˜¯ä¸€ç§ç»´æ•° 3 X 3 çš„å•åº”æ€§çŸ©é˜µï¼ˆHomography ï¼‰ã€‚å‚è€ƒç›®å½•é‡Œæœ‰ç¯‡èµ„æ–™å•ç‹¬è®²äº†å®ƒçš„ç›¸å…³ç†è®ºã€‚ä¸‹é¢æ˜¯ä¸€äº›ç®€ç•¥çš„ä»‹ç»ã€‚

### å•åº”æ€§çŸ©é˜µ
è¦æƒ³ä½¿ç”¨å•åº”æ€§çŸ©é˜µæŠŠåŒä¸€ä¸ªåœºæ™¯çš„ä¸¤å¼ ç…§ç‰‡è”ç³»èµ·æ¥ï¼Œéœ€è¦ä¸¤ä¸ªæ¡ä»¶ï¼š
1. ä¸¤å¼ ç…§ç‰‡ä¸­æ‹æ‘„äº†åŒä¸€ä¸ªå¹³é¢
2. è¿™ä¸¤å¹…ç…§ç‰‡æ˜¯é€šè¿‡æ—‹è½¬ç…§ç›¸æœºçš„å…‰å­¦è½´æ¥æ‹æ‘„çš„ã€‚æˆ‘ä»¬åœ¨ç”Ÿæˆå…¨æ™¯å›¾çš„åŒæ—¶å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚

å•åº”æ€§çŸ©é˜µå°±æ˜¯ä¸€ä¸ªç®€å•çš„ 3 X 3 çŸ©é˜µ

![å•åº”æ€§çŸ©é˜µç†è®ºåŸºç¡€1](https://cdn.jsdelivr.net/gh/ylsislove/image-home/test/å•åº”æ€§çŸ©é˜µç†è®ºåŸºç¡€1.png)

å‡è®¾ (x1,y1) æ˜¯ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šçš„ç‚¹ï¼Œ(x2,y2) æ˜¯ç¬¬äºŒå¼ å›¾ç‰‡ä¸Šçš„åŒä¸€ä¸ªç‰©ç†ç‚¹ï¼Œé‚£ä¹ˆä½¿ç”¨å•åº”æ€§çŸ©é˜µå¯ä»¥æ˜ å°„ä»–ä»¬ï¼š

![å•åº”æ€§çŸ©é˜µç†è®ºåŸºç¡€2](https://cdn.jsdelivr.net/gh/ylsislove/image-home/test/å•åº”æ€§çŸ©é˜µç†è®ºåŸºç¡€2.png)


### å¦‚ä½•æ‰¾åˆ°å•åº”æ€§çŸ©é˜µ
å¦‚æœæˆ‘ä»¬çŸ¥é“ä¸¤å¼ å›¾ç‰‡ä¸­ 4 ä¸ªæˆ–è€…æ›´å¤šå¯¹åº”çš„ç‰¹å¾å…³é”®ç‚¹ï¼Œå°±å¯ä»¥ä½¿ç”¨ opencv ä¸­çš„ findHomography æ¥å¾—åˆ°æ­£ä¸¤å¼ å›¾çš„å•åº”æ€§çŸ©é˜µã€‚findHomographyå†…éƒ¨å…¶å®æ˜¯é€šè¿‡è§£ä¸€ç»„çº¿æ€§æ–¹ç¨‹ç»„æ¥æ‰¾åˆ°å•åº”æ€§çŸ©é˜µçš„ã€‚

### å¦‚ä½•æ‰¾åˆ°ç‰¹å¾å…³é”®ç‚¹
å¾ˆå¤šæœºå™¨è§†è§‰éœ€è¦æ‰¾åˆ°å›¾ç‰‡ä¸­ä¸€äº›ç¥å¥‡çš„å…·æœ‰ä¸€å®šç¨³å®šæ€§çš„ç‚¹ã€‚è¿™äº›ç‚¹è¢«ç§°ä¸ºå…³é”®ç‚¹æˆ–è€…ç‰¹å¾ç‚¹ã€‚OpenCV ä¸­å®ç°äº†å¥½å‡ ç§å…³é”®ç‚¹çš„æ£€æµ‹å™¨ï¼ˆe.g. SIFT, SURF, and ORBï¼‰ã€‚ç”±äº SIFTï¼ˆæ‰€ä»¥éè‡ªå·±ç¼–è¯‘ç‰ˆæœ¬çš„ OpenCV4 å°±ä¸èƒ½ä½¿ç”¨è¿™ä¸ªæ£€æµ‹å™¨äº†ï¼‰ å’Œ SURF æ”¶è´¹ï¼Œè€Œ ORB åˆå¿«åˆå‡†åˆå…è´¹ï¼Œæ‰€ä»¥ ORB ä¹Ÿæ˜¯è¶Šæ¥è¶Šæµè¡Œäº†ã€‚

ORB ç‰¹å¾æ£€æµ‹å™¨ç›¸å…³çŸ¥è¯†å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„æ€»ç»“ï¼š[ORB_FAST ç‰¹å¾å…³é”®ç‚¹æ£€æµ‹](../2020-05-30/å›¾åƒå¤„ç†-ORB_FASTç‰¹å¾å…³é”®ç‚¹æ£€æµ‹.md)

è¿™é‡Œä¹Ÿæ€»ç»“ä¸€ä¸‹ã€‚ä¸€ä¸ªç‰¹å¾ç‚¹æ£€æµ‹å™¨ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š
1. å®šä½å™¨ã€‚è¿™ä¸ªæ¨¡å—è¦æ‰¾åˆ°å›¾ç‰‡ä¸Šå…·æœ‰æ—‹è½¬ä¸å˜æ€§ã€ç¼©æ”¾ä¸å˜æ€§åŠä»¿å°„ä¸å˜æ€§çš„ç‚¹ã€‚å®šä½å™¨æ‰¾åˆ°è¿™äº›ç‚¹çš„ (x, y) åæ ‡ã€‚ORB çš„å®šä½å™¨è¢«ç§°ä¸º FASTã€‚è¿™ç§å¯»æ‰¾ç‰¹å¾ç‚¹çš„ç®—æ³•ä¸€å¬å°±çŸ¥é“ï¼Œå¾ˆå¿«å˜›ã€‚
2. ä¸Šä¸€æ­¥åªæ˜¯æ‰¾åˆ°ç‰¹å¾ç‚¹åœ¨å“ªï¼Œè¿™ä¸€æ­¥è¦è·å¾—å®ƒä»¬çš„å¤–è§‚ç¼–ç æ¥åŒºåˆ†å½¼æ­¤ã€‚è¿™æ ·ç‰¹å¾ç‚¹å°±å¯ä»¥ä½¿ç”¨è¢«ç§°ä¸ºæè¿°å­çš„ä¸€ä¸²æ•°å­—æ¥è¡¨ç¤ºäº†ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸åŒç…§ç‰‡ä¸Šå¯¹åº”çš„åŒä¸€ä¸ªç‰©ç†ç‚¹åº”è¯¥å…·æœ‰ç›¸åŒçš„æè¿°å­ã€‚ORB çš„æè¿°å­æ˜¯ä¸€ç§æ”¹è¿›çš„ BRISK æè¿°å­ã€‚

ç”±äºåªæœ‰çŸ¥é“ä¸¤å¼ å›¾ç‰‡ç‰¹å¾ç‚¹å¯¹åº”å…³ç³»çš„æƒ…å†µä¸‹æ‰èƒ½è®¡ç®—ä¸¤å›¾çš„å•åº”æ€§çŸ©é˜µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç®—æ³•æ¥è‡ªåŠ¨åŒ¹é…ä¸¤å›¾çš„ç‰¹å¾ç‚¹ã€‚è¿™ä¸ªç®—æ³•å°†ä¼šæŠŠä¸¤å›¾çš„ç‰¹å¾ç‚¹ä¸€ä¸€æ¯”è¾ƒã€‚


## OpenCV å›¾åƒå¯¹é½ä»£ç 

### åŸºäºç‰¹å¾çš„å›¾åƒå¯¹é½æ­¥éª¤
1. **è¯»å–å›¾ç‰‡**åˆ°å†…å­˜
2. **æ£€æµ‹ç‰¹å¾ç‚¹**ã€‚ä¸ºä¸¤å¼ å›¾æ£€æµ‹ ORB ç‰¹å¾ç‚¹ã€‚ä¸ºäº†è®¡ç®—å•åº”æ€§çŸ©é˜µ 4 ä¸ªå°±å¤Ÿäº†ï¼Œä½†æ˜¯ä¸€èˆ¬ä¼šæ£€æµ‹åˆ°æˆç™¾ä¸Šåƒçš„ç‰¹å¾ç‚¹ã€‚å¯ä»¥ä½¿ç”¨å‚æ•° MAX_FEATURES æ¥æ§åˆ¶æ£€æµ‹çš„ç‰¹å¾ç‚¹çš„æ•°é‡ã€‚æ£€æµ‹ç‰¹å¾ç‚¹å¹¶è®¡ç®—æè¿°å­çš„å‡½æ•°æ˜¯ detectAndComputeã€‚
3. **ç‰¹å¾åŒ¹é…**ã€‚æ‰¾åˆ°ä¸¤å›¾ä¸­åŒ¹é…çš„ç‰¹å¾ç‚¹ï¼Œå¹¶æŒ‰ç…§åŒ¹é…åº¦æ’åˆ—ï¼Œä¿ç•™æœ€åŒ¹é…çš„ä¸€å°éƒ¨åˆ†ã€‚ç„¶åæŠŠåŒ¹é…çš„ç‰¹å¾ç‚¹ç”»å‡ºæ¥å¹¶ä¿å­˜å›¾ç‰‡åˆ°ç£ç›˜ã€‚æˆ‘ä»¬ä½¿ç”¨æ±‰æ˜è·ç¦»æ¥åº¦é‡ä¸¤ä¸ªç‰¹å¾ç‚¹æè¿°å­çš„ç›¸ä¼¼åº¦ã€‚
4. **è®¡ç®—å•åº”æ€§çŸ©é˜µ**ã€‚ä¸Šä¸€æ­¥äº§ç”Ÿçš„åŒ¹é…çš„ç‰¹å¾ç‚¹ä¸æ˜¯ 100% æ­£ç¡®çš„ï¼Œå°±ç®—åªæœ‰ 20% ~ 30% çš„åŒ¹é…æ˜¯æ­£ç¡®çš„ä¹Ÿä¸ç½•è§ã€‚findHomography å‡½æ•°ä½¿ç”¨ä¸€ç§è¢«ç§°ä¸ºéšæœºæŠ½æ ·ä¸€è‡´ç®—æ³•(Random Sample Consensus)çš„æŠ€æœ¯åœ¨å¤§é‡åŒ¹é…é”™è¯¯çš„æƒ…å†µä¸‹è®¡ç®—å•åº”æ€§çŸ©é˜µã€‚
5. **æ‰­è½¬å›¾ç‰‡(Warping image)**ã€‚æœ‰äº†ç²¾ç¡®çš„å•åº”æ€§çŸ©é˜µï¼Œå°±å¯ä»¥æŠŠä¸€å¼ å›¾ç‰‡çš„æ‰€æœ‰åƒç´ æ˜ å°„åˆ°å¦ä¸€ä¸ªå›¾ç‰‡ã€‚warpPerspective å‡½æ•°ç”¨æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚

### ä»£ç æ¼”ç¤º
ä¸‹é¢çš„ä»£ç æ¥è‡ª[ã€ŠImage Alignment (Feature Based) using OpenCV (C++/Python)ã€‹](https://www.learnopencv.com/image-alignment-feature-based-using-opencv-c-python/)

```python
from __future__ import print_function
import cv2
import numpy as np

MAX_FEATURES = 500
GOOD_MATCH_PERCENT = 0.15

def alignImages(im1, im2):

    # Convert images to grayscale
    im1Gray = cv2.cvtColor(im1, cv2.COLOR_BGR2GRAY)
    im2Gray = cv2.cvtColor(im2, cv2.COLOR_BGR2GRAY)

    # Detect ORB features and compute descriptors.
    orb = cv2.ORB_create(MAX_FEATURES)
    keypoints1, descriptors1 = orb.detectAndCompute(im1Gray, None)
    keypoints2, descriptors2 = orb.detectAndCompute(im2Gray, None)

    # Match features.
    matcher = cv2.DescriptorMatcher_create(cv2.DESCRIPTOR_MATCHER_BRUTEFORCE_HAMMING)
    matches = matcher.match(descriptors1, descriptors2, None)

    # Sort matches by score
    matches.sort(key=lambda x: x.distance, reverse=False)

    # Remove not so good matches
    numGoodMatches = int(len(matches) * GOOD_MATCH_PERCENT)
    matches = matches[:numGoodMatches]

    # Draw top matches
    imMatches = cv2.drawMatches(im1, keypoints1, im2, keypoints2, matches, None)
    cv2.imwrite("matches.jpg", imMatches)

    # Extract location of good matches
    points1 = np.zeros((len(matches), 2), dtype=np.float32)
    points2 = np.zeros((len(matches), 2), dtype=np.float32)

    for i, match in enumerate(matches):
        points1[i, :] = keypoints1[match.queryIdx].pt
        points2[i, :] = keypoints2[match.trainIdx].pt

    # Find homography
    h, mask = cv2.findHomography(points1, points2, cv2.RANSAC)

    # Use homography
    height, width, channels = im2.shape
    im1Reg = cv2.warpPerspective(im1, h, (width, height))

    return im1Reg, h


if __name__ == '__main__':

    # Read reference image
    refFilename = "form.jpg"
    print("Reading reference image : ", refFilename)
    imReference = cv2.imread(refFilename, cv2.IMREAD_COLOR)

    # Read image to be aligned
    imFilename = "scanned-form.jpg"
    print("Reading image to align : ", imFilename);  
    im = cv2.imread(imFilename, cv2.IMREAD_COLOR)

    print("Aligning images ...")
    # Registered image will be resotred in imReg. 
    # The estimated homography will be stored in h. 
    imReg, h = alignImages(im, imReference)

    # Write aligned image to disk. 
    outFilename = "aligned.jpg"
    print("Saving aligned image : ", outFilename); 
    cv2.imwrite(outFilename, imReg)

    # Print estimated homography
    print("Estimated homography : \n",  h)
```

### ç»“æœå±•ç¤º

è¿™æ˜¯æ²¡å¯¹é½ä¹‹å‰çš„å›¾ç‰‡ï¼ˆscanned-formï¼‰ä»¥åŠæ¨¡æ¿å›¾ç‰‡ï¼ˆformï¼‰ ğŸ‘‡

![origin_image](https://cdn.jsdelivr.net/gh/ylsislove/image-home/test/origin_image.jpg)

ç‰¹å¾æè¿°å­åŒ¹é… ğŸ‘‡

![matches](https://cdn.jsdelivr.net/gh/ylsislove/image-home/test/matches.jpg)

åŸå›¾ä¸å¯¹é½åçš„å›¾ç‰‡ ğŸ‘‡

![origin_aligned](https://cdn.jsdelivr.net/gh/ylsislove/image-home/test/origin_aligned.jpg)


## å†™åœ¨æœ€å
æ¥ä¸‹æ¥ä¼šè€ƒè™‘ç”¨ç›®å‰æ‰€å­¦çš„çŸ¥è¯†å®ç°å…¨æ™¯å›¾æ‹¼æ¥ï¼Œä¹Ÿæ˜¯é¡¹ç›®éœ€è¦ï¼Œæ•¬è¯·æœŸå¾…å§~